<!doctype html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Virtual World ViewPoint</title>
  <script type="text/javascript" src="../javascript/threejs/three.js"></script>
  <script type="text/javascript" src="../javascript/threejs/js/loaders/GLTFLoader.js"></script>
  <script type="text/javascript" src="https://webrti.herokuapp.com/script/javascript/utility.js"></script>
  <script type="text/javascript" src="https://webrti.herokuapp.com/script/javascript/WebRTI.js"></script>
  <script type="text/javascript" src="https://webrti.herokuapp.com/script/javascript/socket.io-1.2.0.js"></script>
  <script type="module">

    import mod_EntityManager from "../modules/EntityManager.mjs";
    import mod_PlanetModel from "../modules/PlanetModel.mjs";
    import mod_PlanetRenderer from "../modules/PlanetRenderer.mjs";
    import mod_GamePad from "https://wlee0515.github.io/site/modules/GamePad.mjs";

    const gDegToRad = Math.PI / 180;
    const gRadToDeg = 180 / Math.PI;

    var gGlobal = {
      Time: {
        LastTimeStamp: (new Date()).getTime()
      },

      ControlInput: {
        JoyStick1: null,
        JoyStick2: null,
        OutputDiv_J1_id: "id_JoyStick_1",
        OutputDiv_J2_id: "id_JoyStick_2",
      },

      ViewPoint: {
        CanvasId: "id_OutputCanvas",
        DrawRadius: 5000,
        PlanetRenderer: null,
      },

      Ownship: {
        location: [0.0, 0.0, 0.0],
        eulerAngle: [0.0, 0.0, 0.0],
        modelPath: "https://wlee0515.github.io/site/pages/SimpleGame/Horse.glb",
        modelRotation: [0.0, 180.0, 0.0],
        modelOffset: [0.0, -0.05, 0.0],
        modelScale: [1.0, 1.0, 1.0],

      },

      socket: null,
      webRTI: null,
      EntityManager: null,
      placeHolder: 0
    }

    function updateJoystick(iDt) {

      var wJ1_State = { x: 0, y: 0, z: 0 };
      var wJ2_State = { x: 0, y: 0, z: 0 };

      if (null != gGlobal.ControlInput.JoyStick1) {
        wJ1_State = gGlobal.ControlInput.JoyStick1.getAxisPosition();
      }

      if (null != gGlobal.ControlInput.JoyStick2) {
        wJ2_State = gGlobal.ControlInput.JoyStick2.getAxisPosition();
      }

      gGlobal.Ownship.eulerAngle[0] = wJ2_State.z * 90;
      gGlobal.Ownship.eulerAngle[1] = wJ2_State.y * 90;
      gGlobal.Ownship.eulerAngle[2] += wJ2_State.x;

      var wOverallGain = 1;
      var wGain = [100.0, 100.0, 100.0];
      var wPositionChange = [wJ1_State.y, wJ1_State.x, wJ1_State.z];
      wPositionChange[0] = wPositionChange[0] * wGain[0] * wOverallGain;
      wPositionChange[1] = wPositionChange[1] * wGain[1] * wOverallGain;
      wPositionChange[2] = wPositionChange[2] * wGain[2] * wOverallGain;

      var wNewPosition = mod_PlanetModel.addBodyVectorToGeoLocation(gGlobal.Ownship.location[0]
        , gGlobal.Ownship.location[1]
        , gGlobal.Ownship.location[2]
        , gGlobal.Ownship.eulerAngle[0]
        , gGlobal.Ownship.eulerAngle[1]
        , gGlobal.Ownship.eulerAngle[2]
        , wPositionChange);

      gGlobal.Ownship.location[0] = wNewPosition.latitude;
      gGlobal.Ownship.location[1] = wNewPosition.longitude;
      gGlobal.Ownship.location[2] = wNewPosition.altitude;

    }

    function updateEntities(iDt) {
      var wEntityList = [
        {
          id: "Ownship",
          time: (new Date()).getTime(),
          location: gGlobal.Ownship.location,
          eulerAngle: gGlobal.Ownship.eulerAngle,
          modelPath: gGlobal.Ownship.modelPath,
          modelRotation: gGlobal.Ownship.modelRotation,
          modelOffset: gGlobal.Ownship.modelOffset,
          modelScale: gGlobal.Ownship.modelScale
        }
      ]

      var wEntityId = gGlobal.EntityManger.generateEntityIdString("self", "Ownship");
      gGlobal.EntityManger.setEntityPosition(wEntityId, gGlobal.Ownship.location, gGlobal.Ownship.eulerAngle);
      gGlobal.ViewPoint.PlanetRenderer.setEntityModel(wEntityId, gGlobal.Ownship.modelPath, gGlobal.Ownship.modelRotation, gGlobal.Ownship.modelOffset, gGlobal.Ownship.modelScale)

      gGlobal.webRTI.setObject("EntityManager", "EntityList", wEntityList);

      var wRemote = gGlobal.webRTI.getRemoteObjectList("EntityManager", "EntityList");

      if (null != wRemote) {

        var wEntries = Object.entries(wRemote);

        for (var wi = 0; wi < wEntries.length; ++wi) {
          var wRemoteList = wEntries[wi][1];

          for (var wj = 0; wj < wRemoteList.length; ++wj) {
            var wEntity = wRemoteList[wj];
            var wEntityId = gGlobal.EntityManger.generateEntityIdString(wEntries[wi][0], wEntity.id);
            gGlobal.EntityManger.setEntityPosition(wEntityId, wEntity.location, wEntity.eulerAngle);
            gGlobal.ViewPoint.PlanetRenderer.setEntityModel(wEntityId, wEntity.modelPath, wEntity.modelRotation, wEntity.modelOffset, wEntity.modelScale)

          }

        }
      }
      gGlobal.EntityManger.removeNoneUpdated();

    }

    function processTime(iDt) {
      updateJoystick(iDt);
      updateEntities(iDt);
      gGlobal.ViewPoint.PlanetRenderer.updateCameraLocation(iDt, gGlobal.Ownship.location, gGlobal.Ownship.eulerAngle);
      gGlobal.ViewPoint.PlanetRenderer.updateScene(iDt);
    }

    function tick() {
      clearLog();
      log("Time : " + (new Date()).getTime() + " ms");

      var wTimeStep = (new Date()).getTime() - gGlobal.Time.LastTimeStamp;
      wTimeStep /= 1000;

      log("Time Step : " + wTimeStep + " s");

      processTime(wTimeStep);
      window.requestAnimationFrame(tick);
      gGlobal.Time.LastTimeStamp = (new Date()).getTime();

    }

    function log(iLog) {
      var wDOM = document.getElementById("LogArea")
      wDOM.value += iLog + "\n";
    }

    function clearLog() {
      var wDOM = document.getElementById("LogArea")
      wDOM.value = "";
    }

    function init() {

      console.log = function () {
        log("Console LOG: " + Array.from(arguments));
      }

      console.warn = function () {
        log("Console WARN: " + Array.from(arguments));
      }

      console.error = function () {
        log("Console ERROR: " + Array.from(arguments));
      }

      log("Console Setup Complete");

      if (null != mod_GamePad) {
        var wJ1 = document.getElementById(gGlobal.ControlInput.OutputDiv_J1_id);
        gGlobal.ControlInput.JoyStick1 = new mod_GamePad.ThreeAxisJoystick(wJ1, true, 2);

        var wJ2 = document.getElementById(gGlobal.ControlInput.OutputDiv_J2_id);
        gGlobal.ControlInput.JoyStick2 = new mod_GamePad.ThreeAxisJoystick(wJ2, false, 7);

        log("Joystick Creation Complete");
      }


      gGlobal.socket = io("https://webrti.herokuapp.com");
      log("SocketIO Creation Complete");

      gGlobal.webRTI = new WebRTI(gGlobal.socket);
      log("WebRTI Federate Creation Complete");

      gGlobal.EntityManger = new mod_EntityManager.EntityManager();

      log("Entity Manager Creation Complete");

      var wGLTFloader = new THREE.GLTFLoader();
      wGLTFloader.crossOrigin = true;

      gGlobal.ViewPoint.PlanetRenderer = new mod_PlanetRenderer.PlanetRenderer(gGlobal.ViewPoint.CanvasId, gGlobal.ViewPoint.DrawRadius, wGLTFloader);
      gGlobal.ViewPoint.PlanetRenderer.bindEntityManager(gGlobal.EntityManger);


      gGlobal.ViewPoint.PlanetRenderer.setupViewPoint();
      log("Setup ViewPoint Complete");

      gGlobal.ViewPoint.PlanetRenderer.setupScene();
      log("Setup Scene Complete");

      log("Starting Tick");
      tick();
    }

    window.addEventListener("load", init);
  </script>

</head>

<style>
  body {
    background: rgb(255, 255, 255);
    margin: 0px;
    padding: 0px;
  }

  #id_JoyStick_1 {
    width: 150px;
    height: 150px;
    z-index: 100;
    position: fixed;
    bottom: 10px;
    left: 10px;
  }

  #id_JoyStick_2 {
    width: 150px;
    height: 150px;
    z-index: 100;
    position: fixed;
    bottom: 10px;
    right: 10px;
  }

  #id_OutputCanvasContainer {
    width: 100vw;
    height: 100vh;
    z-index: 100;
    position: fixed;
    top: 0px;
    left: 0px;
    margin: 0px;
    padding: 0px;
  }

  #id_menu {
    position: fixed;
    top: 0px;
    left: 0px;

  }

  #LogArea {
    resize: both;
    overflow: auto;
    min-width: 300px;
  }
</style>

<body>
  <div id="id_OutputCanvasContainer">
    <canvas id="id_OutputCanvas"></canvas>
  </div>
  <div id="id_menu">
    <textarea id="LogArea"></textarea>
  </div>
  <div id="id_JoyStick_1">
  </div>
  <div id="id_JoyStick_2">
  </div>
  </br>
</body>

</html>